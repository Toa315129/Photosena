<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tomoji Photobooth</title>
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap&family=Great+Vibes&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#fdfdfc;
  --blue:#a7d8f7;
  --pink:#ffd6e8;
  --green:#90c9a7;
  --text:#333;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{
  height:100%;background:var(--bg);
  font-family:"Quicksand",sans-serif;
  display:flex;align-items:center;justify-content:center;padding:16px;
}
.container{
  width:100%;max-width:960px;
  background:#fff;
  border-radius:16px;
  padding:20px;
  border:4px solid var(--blue);
}
h1{text-align:center;font-size:2rem;color:var(--text);margin-bottom:16px}
.hidden{display:none}
.center{text-align:center}

/* ‡∏õ‡∏∏‡πà‡∏° */
.btn{
  padding:10px 18px;
  border-radius:12px;
  border:2px solid var(--blue);
  background:var(--blue);
  color:#fff;
  font-weight:600;
  margin:4px;
  cursor:pointer;
  transition:all .2s;
}
.btn:hover{background:var(--green);border-color:var(--green);}
.shutter{
  width:100px;height:100px;
  border-radius:50%;
  background:#fff;
  border:6px solid var(--blue);
  margin:12px auto;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;
  transition:.2s;
}
.shutter:hover{background:var(--pink);}
.note{font-size:14px;color:var(--text);margin-top:6px;text-align:center}

/* ‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß */
.preview{
  width:100%;max-width:480px;
  margin:0 auto;
  border-radius:12px;
  overflow:hidden;
  position:relative;
  border:4px solid var(--green);
}
#video{width:100%;height:auto;object-fit:cover;transform:scaleX(-1);}
.countdown{
  position:absolute;inset:0;
  display:flex;align-items:center;justify-content:center;
  font-size:4rem;font-weight:700;
  color:var(--pink);
}
.flash{position:absolute;inset:0;background:#fff;opacity:0;transition:.18s}
.flash.show{opacity:.9}

/* ‡πÇ‡∏û‡∏•‡∏≤‡∏£‡∏≠‡∏¢‡∏î‡πå */
.final-frame{
  width:100%;max-width:600px;
  margin:20px auto;text-align:center;
}
.final-frame canvas{width:100%;border:8px solid #fff;box-shadow:0 4px 10px rgba(0,0,0,0.15);}

/* ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï */
.credit{margin-top:10px;text-align:center;font-size:14px;font-family:"Great Vibes",cursive;color:#666}
</style>
</head>
<body>
<div class="container">
  <h1>üì∏ Tomoji Photobooth</h1>

  <!-- ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô -->
  <div id="step1">
    <p class="center">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</p>
    <div class="center">
      <button class="btn" onclick="setCount(2)">2 ‡∏£‡∏π‡∏õ</button>
      <button class="btn" onclick="setCount(4)">4 ‡∏£‡∏π‡∏õ</button>
      <button class="btn" onclick="setCount(6)">6 ‡∏£‡∏π‡∏õ</button>
    </div>
  </div>

  <!-- ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á -->
  <div id="step2" class="hidden">
    <div class="preview">
      <video id="video" autoplay playsinline></video>
      <div class="countdown" id="countdown"></div>
      <div class="flash" id="flash"></div>
    </div>
    <div class="shutter" id="shutter"></div>
    <p class="note">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</p>
  </div>

  <!-- ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• -->
  <div id="step3" class="hidden">
    <div class="final-frame"><canvas id="finalCanvas"></canvas></div>
    <div class="center">
      <button class="btn" onclick="downloadImage()">Download</button>
      <button class="btn" onclick="window.print()">Print</button>
      <button class="btn" onclick="makeQR()">QR Code</button>
    </div>
    <div class="center" id="qrcode"></div>
  </div>

  <div class="credit">@tomoji studio</div>
</div>

<audio id="snap" src="https://cdn.jsdelivr.net/gh/naptha/talkdemo/snap.mp3" preload="auto"></audio>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
let photoCount=0;
let captures=[];
const video=document.getElementById('video');
const shutter=document.getElementById('shutter');
const countdownEl=document.getElementById('countdown');
const flash=document.getElementById('flash');
const snap=document.getElementById('snap');

async function setCount(n){
  photoCount=n;
  document.getElementById('step1').classList.add('hidden');
  document.getElementById('step2').classList.remove('hidden');
  startCamera();
}
async function startCamera(){
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});
    video.srcObject=stream;
  }catch(e){alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: "+e);}
}
function showCount(n){countdownEl.textContent=n;}
function hideCount(){countdownEl.textContent="";}
function doFlash(){snap.currentTime=0;snap.play();flash.classList.add('show');setTimeout(()=>flash.classList.remove('show'),150);}
function captureFrame(){
  const c=document.createElement('canvas');
  c.width=video.videoWidth;c.height=video.videoHeight;
  const ctx=c.getContext('2d');
  ctx.translate(c.width,0);ctx.scale(-1,1);
  ctx.drawImage(video,0,0,c.width,c.height);
  return c.toDataURL('image/png');
}
shutter.addEventListener('click',async()=>{
  captures=[];
  for(let i=0;i<photoCount;i++){
    for(let s=3;s>=1;s--){showCount(s);await new Promise(r=>setTimeout(r,1000));}
    hideCount();doFlash();
    captures.push(captureFrame());
    await new Promise(r=>setTimeout(r,500));
  }
  buildFinal();
});
function buildFinal(){
  document.getElementById('step2').classList.add('hidden');
  document.getElementById('step3').classList.remove('hidden');

  const W=1200,H=1800;
  const c=document.getElementById('finalCanvas');
  c.width=W;c.height=H;
  const ctx=c.getContext('2d');
  ctx.fillStyle="#fff";ctx.fillRect(0,0,W,H);

  const margin=60,gap=20;
  const cols=2;
  const rows=Math.ceil(photoCount/cols);
  const boxW=(W-margin*2-gap*(cols-1))/cols;
  const boxH=(H-margin*2-gap*(rows-1))/rows;

  captures.forEach((src,i)=>{
    const img=new Image();img.src=src;
    img.onload=()=>{
      const col=i%cols,row=Math.floor(i/cols);
      const x=margin+col*(boxW+gap);
      const y=margin+row*(boxH+gap);
      const scale=Math.min(boxW/img.width,boxH/img.height);
      const iw=img.width*scale,ih=img.height*scale;
      const dx=x+(boxW-iw)/2,dy=y+(boxH-ih)/2;
      ctx.drawImage(img,dx,dy,iw,ih);
    };
  });
}
function downloadImage(){
  const link=document.createElement('a');
  link.download='tomoji_photobooth.png';
  link.href=document.getElementById('finalCanvas').toDataURL();
  link.click();
}
function makeQR(){
  document.getElementById('qrcode').innerHTML="";
  const data=document.getElementById('finalCanvas').toDataURL();
  new QRCode(document.getElementById('qrcode'),{text:data,width:200,height:200});
}
</script>
</body>
</html>
