<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SENA PHOTOBOOTH</title>
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#fdfaf4;
  --blue:#a7d8f7;
  --pink:#ffd6e8;
  --text:#333;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);font-family:"Quicksand",sans-serif;}

/* container หลัก */
.page{display:none;min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;}
.page.active{display:flex;}

/* header */
.header{font-size:42px;font-weight:700;color:var(--blue);margin-bottom:20px;text-align:center;}

/* ปุ่ม */
.btn{
  padding:12px 18px;
  border-radius:12px;
  border:2px solid var(--blue);
  background:#fff;
  color:var(--text);
  font-weight:600;
  cursor:pointer;
  margin:6px;
  transition:0.2s;
}
.btn:hover{background:var(--blue);color:#fff}
.shutter{width:80px;height:80px;border-radius:50%;border:6px solid var(--blue);background:#fff;cursor:pointer;margin:12px;}
.shutter:hover{background:var(--pink)}

/* video */
.preview{width:300px;height:400px;background:#fff;border-radius:12px;overflow:hidden;position:relative;border:4px solid var(--blue);}
#video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1);}

/* gallery */
.gallery{display:grid;gap:14px;margin-top:16px;}
.gallery.two{grid-template-columns:1fr;}
.gallery.three{grid-template-columns:1fr;}
.gallery.four{grid-template-columns:1fr 1fr;}
.gallery.six{grid-template-columns:1fr 1fr 1fr;}
.polaroid{
  position:relative;
  background:#fff;
  padding:8px 8px 24px 8px;
  border-radius:10px;
  box-shadow:0 6px 14px rgba(0,0,0,0.15);
}
.polaroid img{width:100%;height:100%;object-fit:cover;border-radius:6px;}
.deco{
  position:absolute;
  font-size:18px;
  pointer-events:none;
  opacity:0.8;
}
.note{text-align:center;font-size:14px;color:#555;margin-top:6px}
</style>
</head>
<body>

<!-- หน้าเลือกจำนวน -->
<div class="page active" id="page-select">
  <div class="header">SENA PHOTOBOOTH</div>
  <p style="margin-bottom:16px;color:var(--text)">เลือกจำนวนช่อง</p>
  <div>
    <button class="btn" onclick="startBooth(2)">2 ช่อง</button>
    <button class="btn" onclick="startBooth(3)">3 ช่อง</button>
    <button class="btn" onclick="startBooth(4)">4 ช่อง</button>
    <button class="btn" onclick="startBooth(6)">6 ช่อง</button>
  </div>
</div>

<!-- หน้า photobooth -->
<div class="page" id="page-booth">
  <div class="header">SENA PHOTOBOOTH</div>
  <div class="preview"><video id="video" autoplay playsinline></video></div>
  <div class="note" id="progress">ยังไม่ได้ถ่าย</div>
  <div style="margin-top:12px">
    <div class="shutter" id="shutter"></div>
  </div>
  <div>
    <button class="btn" id="switch">สลับกล้อง</button>
    <button class="btn" id="upload">อัปโหลด</button>
    <button class="btn" id="download" disabled>ดาวน์โหลด</button>
  </div>
  <input type="file" id="fileInput" accept="image/*" multiple hidden>
  <div class="gallery" id="gallery"></div>
</div>

<audio id="snap" src="https://cdn.jsdelivr.net/gh/naptha/talkdemo/snap.mp3" preload="auto"></audio>

<script>
let useFront=true,stream=null,captures=[],total=0;
const video=document.getElementById('video');
const shutter=document.getElementById('shutter');
const switchBtn=document.getElementById('switch');
const uploadBtn=document.getElementById('upload');
const downloadBtn=document.getElementById('download');
const fileInput=document.getElementById('fileInput');
const gallery=document.getElementById('gallery');
const progress=document.getElementById('progress');
const snap=document.getElementById('snap');
let selectedCount=0;

/* --- start camera --- */
async function startCamera(){
  if(stream){stream.getTracks().forEach(t=>t.stop());}
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:useFront?'user':'environment'},audio:false});
    video.srcObject=stream;
  }catch(e){alert("ไม่สามารถเปิดกล้องได้");}
}
switchBtn.addEventListener("click",()=>{useFront=!useFront;startCamera();});

/* --- change page --- */
function startBooth(n){
  selectedCount=n;captures=[];gallery.innerHTML="";
  gallery.className="gallery "+(n==2?"two":n==3?"three":n==4?"four":"six");
  document.getElementById("page-select").classList.remove("active");
  document.getElementById("page-booth").classList.add("active");
  startCamera();
  updateProgress();
}

/* --- capture --- */
function captureFrame(){
  const c=document.createElement('canvas');c.width=video.videoWidth;c.height=video.videoHeight;
  const ctx=c.getContext('2d');ctx.translate(c.width,0);ctx.scale(-1,1);
  ctx.drawImage(video,0,0,c.width,c.height);
  return c.toDataURL('image/png');
}
shutter.addEventListener("click",()=>{if(captures.length>=selectedCount)return;doFlash();captures.push(captureFrame());renderGallery();});
uploadBtn.addEventListener("click",()=>fileInput.click());
fileInput.addEventListener("change",e=>{
  const files=[...e.target.files].slice(0,selectedCount);
  captures=[];
  files.forEach(f=>{const r=new FileReader();r.onload=()=>{captures.push(r.result);renderGallery();};r.readAsDataURL(f);});
});
function doFlash(){snap.currentTime=0;snap.play();}

/* --- render gallery --- */
function renderGallery(){
  gallery.innerHTML="";
  captures.forEach(src=>gallery.appendChild(makePolaroid(src)));
  updateProgress();
  downloadBtn.disabled=(captures.length<selectedCount);
}
function updateProgress(){
  progress.textContent=`ถ่ายแล้ว ${captures.length}/${selectedCount}`;
}

/* --- make polaroid with ✦ decorations --- */
function makePolaroid(src){
  const wrap=document.createElement("div");
  wrap.className="polaroid";
  const img=document.createElement("img");
  img.src=src;wrap.appendChild(img);
  const colors=["#FFD6E8","#A7D8F7","#FFF2A7","#CBA7F7","#A7F7C4"];
  for(let i=0;i<4;i++){
    const deco=document.createElement("span");
    deco.className="deco";
    deco.textContent="✦";
    deco.style.color=colors[Math.floor(Math.random()*colors.length)];
    deco.style.top=Math.random()*90+"%";
    deco.style.left=Math.random()*90+"%";
    wrap.appendChild(deco);
  }
  return wrap;
}

/* --- download final --- */
downloadBtn.addEventListener("click",()=>{
  if(captures.length<selectedCount)return;
  const zipCanvas=document.createElement("canvas");
  const cols=(selectedCount==4||selectedCount==6)?(selectedCount==4?2:3):1;
  const rows=Math.ceil(selectedCount/cols);
  const W=cols*500+40, H=rows*600+60;
  zipCanvas.width=W; zipCanvas.height=H;
  const ctx=zipCanvas.getContext("2d");
  ctx.fillStyle="#fff";ctx.fillRect(0,0,W,H);
  captures.forEach((src,i)=>{
    const img=new Image();img.src=src;
    img.onload=()=>{const col=i%cols,row=Math.floor(i/cols);
      ctx.drawImage(img,col*500+20,row*600+20,460,560);
      if(i==captures.length-1){
        const a=document.createElement("a");
        a.href=zipCanvas.toDataURL("image/png");
        a.download="SENA_Photobooth.png";
        a.click();
      }
    }
  });
});
</script>
</body>
</html>
