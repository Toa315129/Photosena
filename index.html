<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SENA PHOTOBOOTH</title>

<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#fdfaf4;
  --blue:#a7d8f7;
  --pink:#ffd6e8;
  --text:#333;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  background:var(--bg);
  font-family:"Quicksand",sans-serif;
  min-height:100vh;
  display:flex;align-items:center;justify-content:center;
  padding:20px;
}
.container{
  max-width:960px;width:100%;
  background:var(--bg);
  border-radius:18px;
  border:6px solid var(--blue);
  box-shadow:0 6px 18px rgba(0,0,0,0.1);
  padding:20px;
}
.header{text-align:center;margin-bottom:20px;}
.brand{font-size:42px;font-weight:700;color:var(--blue);}

/* หน้าเลือก */
.page{display:none}
.page.active{display:block}
.choices{
  display:flex;justify-content:center;gap:20px;margin-top:30px;flex-wrap:wrap;
}
.choice-btn{
  width:140px;height:180px;
  background:#fff;border:3px solid var(--blue);border-radius:12px;
  display:flex;align-items:center;justify-content:center;flex-direction:column;
  font-weight:600;color:var(--text);cursor:pointer;
  box-shadow:0 4px 10px rgba(0,0,0,0.08);
}
.choice-btn:hover{background:var(--pink);color:#fff}

/* กล้อง */
.preview{
  width:100%;aspect-ratio:3/4;border-radius:12px;overflow:hidden;
  border:4px solid var(--blue);position:relative;background:#fff;
}
#video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1);}
.countdown{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:4rem;font-weight:700;color:var(--pink);}
.flash{position:absolute;inset:0;background:#fff;opacity:0;transition:opacity .2s}
.flash.show{opacity:0.9}

.controls{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:12px}
.btn{
  padding:10px 16px;border:2px solid var(--blue);
  background:#fff;border-radius:10px;
  font-weight:600;color:var(--text);cursor:pointer;
}
.btn:hover{background:var(--blue);color:#fff}
.shutter{width:80px;height:80px;border-radius:50%;border:5px solid var(--blue);background:#fff;cursor:pointer;}
.shutter:hover{background:var(--pink);}

/* Thumbnail */
.thumbs{display:flex;gap:10px;margin-top:10px;justify-content:center;flex-wrap:wrap;}
.thumb{width:100px;aspect-ratio:3/4;background:#fff;border:3px solid var(--blue);border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden;box-shadow:0 4px 10px rgba(0,0,0,0.1);}
.thumb img{width:100%;height:100%;object-fit:cover;}
</style>
</head>
<body>
<div class="container">
  <div class="header"><div class="brand">SENA PHOTOBOOTH</div></div>

  <!-- หน้าเลือกจำนวน -->
  <div class="page active" id="page-choose">
    <h2 style="text-align:center;color:var(--text)">เลือกจำนวนรูป</h2>
    <div class="choices">
      <div class="choice-btn" onclick="startBooth(2)">2 ช่อง</div>
      <div class="choice-btn" onclick="startBooth(4)">4 ช่อง</div>
      <div class="choice-btn" onclick="startBooth(6)">6 ช่อง</div>
    </div>
  </div>

  <!-- หน้าโฟโต้บูธ -->
  <div class="page" id="page-booth">
    <div class="preview"><video id="video" autoplay playsinline></video><div id="countdown" class="countdown"></div><div id="flash" class="flash"></div></div>
    <div class="controls">
      <div class="shutter" id="shutter"></div>
      <button class="btn" id="retake" disabled>ถ่ายใหม่</button>
      <button class="btn" id="switch">สลับกล้อง</button>
      <button class="btn" id="upload">อัปโหลด</button>
      <button class="btn" id="download" disabled>ดาวน์โหลด</button>
      <button class="btn" id="makeqr" disabled>สร้าง QR</button>
      <input type="file" id="fileInput" accept="image/*" multiple hidden>
    </div>
    <div class="thumbs" id="thumbs"></div>
    <div style="text-align:center;margin-top:10px;color:var(--text);font-size:14px">ภาพจะถูกใส่กรอบ Polaroid อัตโนมัติ ✨</div>
    <div id="qrcode" style="margin-top:10px;text-align:center"></div>
  </div>
</div>

<audio id="snap" src="https://cdn.jsdelivr.net/gh/naptha/talkdemo/snap.mp3" preload="auto"></audio>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
let totalShots=0,captures=[],useFront=true,stream=null,finalImage=null;
const pageChoose=document.getElementById('page-choose');
const pageBooth=document.getElementById('page-booth');
const video=document.getElementById('video');
const shutter=document.getElementById('shutter');
const retake=document.getElementById('retake');
const switchBtn=document.getElementById('switch');
const uploadBtn=document.getElementById('upload');
const downloadBtn=document.getElementById('download');
const qrBtn=document.getElementById('makeqr');
const fileInput=document.getElementById('fileInput');
const thumbs=document.getElementById('thumbs');
const countdownEl=document.getElementById('countdown');
const flash=document.getElementById('flash');
const snap=document.getElementById('snap');

function startBooth(n){
  totalShots=n;captures=[];
  pageChoose.classList.remove('active');pageBooth.classList.add('active');
  startCamera();renderThumbs();
}
async function startCamera(){
  if(stream) stream.getTracks().forEach(t=>t.stop());
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:useFront?'user':'environment'}});
    video.srcObject=stream;
  }catch(e){alert("ไม่สามารถเปิดกล้องได้: "+e.message);}
}
switchBtn.onclick=()=>{useFront=!useFront;startCamera();};

function captureFrame(){
  const c=document.createElement('canvas');c.width=video.videoWidth;c.height=video.videoHeight;
  const ctx=c.getContext('2d');ctx.translate(c.width,0);ctx.scale(-1,1);
  ctx.drawImage(video,0,0,c.width,c.height);
  return c.toDataURL("image/png");
}
function renderThumbs(){
  thumbs.innerHTML="";
  for(let i=0;i<totalShots;i++){
    thumbs.innerHTML+=captures[i]?makePolaroid(captures[i]):`<div class="thumb"><span style="opacity:.4">${i+1}</span></div>`;
  }
}
function makePolaroid(imgSrc){
  return `<div class="thumb"><div style="background:#fff;padding:4px 4px 14px;border-radius:6px;box-shadow:0 4px 8px rgba(0,0,0,0.12);width:100%;height:100%;display:flex;align-items:center;justify-content:center;"><img src="${imgSrc}"></div></div>`;
}
async function takeSequence(){
  captures=[];renderThumbs();retake.disabled=true;downloadBtn.disabled=true;qrBtn.disabled=true;shutter.style.pointerEvents="none";
  for(let i=0;i<totalShots;i++){
    for(let s=3;s>=1;s--){countdownEl.textContent=s;await new Promise(r=>setTimeout(r,1000));}
    countdownEl.textContent="";flash.classList.add("show");snap.play().catch(()=>{});await new Promise(r=>setTimeout(r,150));flash.classList.remove("show");
    captures[i]=captureFrame();renderThumbs();
    if(i<totalShots-1) await new Promise(r=>setTimeout(r,1000));
  }
  retake.disabled=false;downloadBtn.disabled=false;qrBtn.disabled=false;shutter.style.pointerEvents="";
}
shutter.onclick=takeSequence;
retake.onclick=()=>{captures=[];renderThumbs();downloadBtn.disabled=true;qrBtn.disabled=true;};

uploadBtn.onclick=()=>fileInput.click();
fileInput.onchange=async(e)=>{
  const files=[...e.target.files].slice(0,totalShots);
  if(files.length<totalShots) return alert("กรุณาเลือก "+totalShots+" รูป");
  captures=[];
  for(const f of files){const r=new FileReader();await new Promise(res=>{r.onload=()=>{captures.push(r.result);res();};r.readAsDataURL(f);});}
  renderThumbs();retake.disabled=false;downloadBtn.disabled=false;qrBtn.disabled=false;
};

async function buildImage(){
  const W=1600,H=2400;const c=document.createElement("canvas");c.width=W;c.height=H;const ctx=c.getContext("2d");
  ctx.fillStyle="#fff";ctx.fillRect(0,0,W,H);
  ctx.fillStyle=varBlue();ctx.fillRect(W/2-400,40,800,100);
  ctx.fillStyle="#fff";ctx.font="64px Quicksand";ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText("SENA PHOTOBOOTH",W/2,90);

  const cols=2, rows=Math.ceil(totalShots/2);
  const gap=20, startX=100, startY=180, boxW=(W-2*startX-gap)/cols, boxH=(H-startY-rows*gap-80)/rows;
  for(let i=0;i<totalShots;i++){
    const row=Math.floor(i/2), col=i%2;
    const x=startX+col*(boxW+gap), y=startY+row*(boxH+gap);
    const img=new Image();img.src=captures[i];await new Promise(r=>img.onload=r);
    const scale=Math.min(boxW/img.width,boxH/img.height);
    const iw=img.width*scale, ih=img.height*scale;
    const dx=x+(boxW-iw)/2, dy=y+(boxH-ih)/2;
    ctx.fillStyle="#fff";ctx.fillRect(x-10,y-10,boxW+20,boxH+40);
    ctx.drawImage(img,dx,dy,iw,ih);
  }
  ctx.fillStyle="#333";ctx.font="28px Quicksand";ctx.fillText("@sena",W/2,H-40);
  return c.toDataURL("image/png");
}
function varBlue(){return "#a7d8f7";}

downloadBtn.onclick=async()=>{if(!captures.length)return;finalImage=await buildImage();const a=document.createElement("a");a.href=finalImage;a.download="Sena_booth.png";a.click();};
qrBtn.onclick=async()=>{if(!captures.length)return;finalImage=await buildImage();document.getElementById("qrcode").innerHTML="";new QRCode(document.getElementById("qrcode"),{text:finalImage,width:200,height:200});};
</script>
</body>
</html>
